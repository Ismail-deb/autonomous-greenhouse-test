const int mq2AnalogPin = 34; // Connect the AO pin of your MQ2 module to ESP32 GPIO34

// --- IMPORTANT: VOLTAGE DIVIDER REQUIRED ---
// MQ2 outputs 0-5V, but ESP32 ADC can only handle 0-3.3V
// Use a voltage divider to scale down the voltage
// 
// Connection:
// MQ2 AO ----[4.7k立]---- ESP32 GPIO34 ----[10k立]---- GND
//

// --- Calibration Variables ---
int cleanAirBaseline = 0;       // Analog value in genuinely clean air
const int baselineBuffer = 300; // Allow for normal fluctuations

// Thresholds are DIFFERENTIAL from the baseline.
// These represent how much the reading needs to *drop* from the baseline to trigger.
const int warningDropThreshold = 750;  // Reading must drop by at least 750 from baseline for warning
const int alarmDropThreshold = 1500;   // Reading must drop by at least 1500 from baseline for alarm

void setup() {
  Serial.begin(115200);
  Serial.println("MQ2 Gas Sensor (LPG) - 5V Analog Output with Voltage Divider");
  Serial.println("----------------------------------------------");
  Serial.println(">>> CRITICAL: MQ2 Sensor Extended Pre-heating & Baseline Calibration <<<");
  Serial.println(">>> HARDWARE: Connect voltage divider: MQ2 AO --[4.7k立]-- GPIO34 --[10k立]-- GND <<<");
  Serial.println("Place sensor in a genuinely CLEAN AIR environment.");
  Serial.println("Allow at least 5 MINUTES for the sensor to warm up for stable readings.");
  Serial.println("Do NOT introduce any gas or smoke during this phase.");
  Serial.println("----------------------------------------------");

  // Extended Pre-heating Time (5 minutes = 300 seconds)
  for (int i = 0; i < 300; i++) {
    Serial.print("Extended Pre-heating... ");
    Serial.print(300 - i);
    Serial.println("s remaining.");
    delay(1000);
  }
  Serial.println("Extended Pre-heating complete. Now calibrating baseline in clean air...");

  // Read a stable baseline in clean air (after extended pre-heating)
  long sumReadings = 0;
  for (int i = 0; i < 200; i++) { // Take 200 readings for a very stable average baseline
    sumReadings += analogRead(mq2AnalogPin);
    delay(50); // Small delay between readings
  }
  cleanAirBaseline = sumReadings / 200;
  
  Serial.print("FINAL Clean Air Baseline: ");
  Serial.println(cleanAirBaseline);
  Serial.print("Baseline Buffer: +/- ");
  Serial.println(baselineBuffer);
  Serial.println("----------------------------------------------");
  Serial.println("Now observing gas levels. Introduce gas *VERY CAREFULLY* for testing thresholds.");
  Serial.println("----------------------------------------------");
}

void loop() {
  int gasRawValue = analogRead(mq2AnalogPin);
  
  Serial.print("Current Gas Value: ");
  Serial.println(gasRawValue);

  // Calculate the difference from the clean air baseline
  int dropFromBaseline = cleanAirBaseline - gasRawValue;

  Serial.print("Drop from Baseline: ");
  Serial.println(dropFromBaseline);

  // --- INTERPRETATION LOGIC ---
  // If the sensor value *drops* significantly from the baseline, it means gas is detected.

  if (dropFromBaseline > alarmDropThreshold) {
    Serial.println("!!! DANGEROUS GAS LEAK DETECTED (CRITICAL ALARM) !!!");
    // Actions: Trigger loud siren, cut power, urgent notifications.
  } else if (dropFromBaseline > warningDropThreshold) {
    Serial.println(">> Warning: Elevated Gas Concentration Detected <<");
    // Actions: Send mild notification, activate ventilation fan, log event.
  } else if (dropFromBaseline > baselineBuffer) {
     Serial.println("Slight increase in gas detected (above normal fluctuation).");
     // Actions: Log for trend analysis, subtle indication.
  }
  else {
    Serial.println("Gas level is safe (within baseline fluctuations).");
  }

  Serial.println(); // Blank line for readability
  delay(1000);      // Read every second
}
